// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Adds a user activity indicator to posts
// @grant           none
// @homepage        https://github.com/userscripters/activity-indicator#readme
// @match           https://*.askubuntu.com/*
// @match           https://*.mathoverflow.net/*
// @match           https://*.serverfault.com/*
// @match           https://*.stackapps.com/*
// @match           https://*.stackexchange.com/*
// @match           https://*.stackoverflow.com/*
// @name            Activity Indicator
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/activity-indicator.git
// @supportURL      https://github.com/userscripters/activity-indicator/issues
// @version         1.0.0
// ==/UserScript==

"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var s in t=arguments[n])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,a,o,u){return new(o=o||Promise)(function(n,t){function r(e){try{i(u.next(e))}catch(e){t(e)}}function s(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(r,s)}i((u=u.apply(e,a||[])).next())})},__generator=this&&this.__generator||function(n,r){var s,i,a,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(s)throw new TypeError("Generator is already executing.");for(;o;)try{if(s=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,i=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(a=0<(a=o.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){o.label=t[1];break}if(6===t[0]&&o.label<a[1]){o.label=a[1],a=t;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(t);break}a[2]&&o.ops.pop(),o.trys.pop();continue}t=r.call(n,o)}catch(e){t=[6,e],i=0}finally{s=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__rest=this&&this.__rest||function(e,t){var n={};for(s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(n[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,s=Object.getOwnPropertySymbols(e);r<s.length;r++)t.indexOf(s[r])<0&&Object.prototype.propertyIsEnumerable.call(e,s[r])&&(n[s[r]]=e[s[r]]);return n},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,s,i=n.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(r=i.next()).done;)a.push(r.value)}catch(e){s={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(s)throw s.error}}return a},__spreadArray=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,s=0,i=t.length;s<i;s++)!r&&s in t||((r=r||Array.prototype.slice.call(t,0,s))[s]=t[s]);return e.concat(r||Array.prototype.slice.call(t))};!function(e,h,g){function _(t){return void 0===t&&(t=100),new Promise(function(e){return setTimeout(e,t)})}function y(f,d){return __awaiter(void 0,void 0,void 0,function(){var t,n,r,s,i,a,o,u,e=d.site,c=void 0===e?"stackoverflow":e,e=d.page,l=void 0===e?1:e,p=__rest(d,["site","page"]);return __generator(this,function(e){switch(e.label){case 0:return(t=new URL(w+"/2.3/questions/"+f+"/comments")).search=new URLSearchParams(__assign({site:c,page:l.toString()},p)).toString(),[4,fetch(t.toString())];case 1:return(s=e.sent()).ok?[4,s.json()]:[2,[]];case 2:return s=e.sent(),r=s.items,n=void 0===r?[]:r,r=s.has_more,r=void 0!==r&&r,(s=s.backoff)?[4,_(1e3*s)]:[3,4];case 3:return e.sent(),[2,y(f,__assign({site:c,page:l},p))];case 4:return r?(a=(i=n.push).apply,o=[n],u=[[]],[4,y(f,__assign({site:c,page:l+1},p))]):[3,6];case 5:a.apply(i,o.concat([__spreadArray.apply(void 0,u.concat([__read.apply(void 0,[e.sent()]),!1]))])),e.label=6;case 6:return[2,n]}})})}function v(f,d){return __awaiter(void 0,void 0,void 0,function(){var t,n,r,s,i,a,o,u,e=d.site,c=void 0===e?"stackoverflow":e,e=d.page,l=void 0===e?1:e,p=__rest(d,["site","page"]);return __generator(this,function(e){switch(e.label){case 0:return(t=new URL(w+"/2.3/answers/"+f+"/comments")).search=new URLSearchParams(__assign({site:c,page:l.toString()},p)).toString(),[4,fetch(t.toString())];case 1:return(s=e.sent()).ok?[4,s.json()]:[2,[]];case 2:return s=e.sent(),r=s.items,n=void 0===r?[]:r,r=s.has_more,r=void 0!==r&&r,(s=s.backoff)?[4,_(1e3*s)]:[3,4];case 3:return e.sent(),[2,v(f,__assign({site:c,page:l},p))];case 4:return r?(a=(i=n.push).apply,o=[n],u=[[]],[4,v(f,__assign({site:c,page:l+1},p))]):[3,6];case 5:a.apply(i,o.concat([__spreadArray.apply(void 0,u.concat([__read.apply(void 0,[e.sent()]),!1]))])),e.label=6;case 6:return[2,n]}})})}function b(f,d){return __awaiter(void 0,void 0,void 0,function(){var t,n,r,s,i,a,o,u,e=d.site,c=void 0===e?"stackoverflow":e,e=d.page,l=void 0===e?1:e,p=__rest(d,["site","page"]);return __generator(this,function(e){switch(e.label){case 0:return(t=new URL(w+"/2.3/questions/"+f)).search=new URLSearchParams(__assign({site:c,page:l.toString()},p)).toString(),[4,fetch(t.toString())];case 1:return(s=e.sent()).ok?[4,s.json()]:[2,[]];case 2:return s=e.sent(),r=s.items,n=void 0===r?[]:r,r=s.has_more,r=void 0!==r&&r,(s=s.backoff)?[4,_(1e3*s)]:[3,4];case 3:return e.sent(),[2,b(f,__assign({site:c,page:l},p))];case 4:return r?(a=(i=n.push).apply,o=[n],u=[[]],[4,b(f,__assign({site:c,page:l+1},p))]):[3,6];case 5:a.apply(i,o.concat([__spreadArray.apply(void 0,u.concat([__read.apply(void 0,[e.sent()]),!1]))])),e.label=6;case 6:return[2,n]}})})}function m(f,d){return __awaiter(void 0,void 0,void 0,function(){var t,n,r,s,i,a,o,u,e=d.site,c=void 0===e?"stackoverflow":e,e=d.page,l=void 0===e?1:e,p=__rest(d,["site","page"]);return __generator(this,function(e){switch(e.label){case 0:return(t=new URL(w+"/2.3/questions/"+f+"/answers")).search=new URLSearchParams(__assign({site:c,page:l.toString()},p)).toString(),[4,fetch(t.toString())];case 1:return(s=e.sent()).ok?[4,s.json()]:[2,[]];case 2:return s=e.sent(),r=s.items,n=void 0===r?[]:r,r=s.has_more,r=void 0!==r&&r,(s=s.backoff)?[4,_(1e3*s)]:[3,4];case 3:return e.sent(),[2,m(f,__assign({site:c,page:l},p))];case 4:return r?(a=(i=n.push).apply,o=[n],u=[[]],[4,m(f,__assign({site:c,page:l+1},p))]):[3,6];case 5:a.apply(i,o.concat([__spreadArray.apply(void 0,u.concat([__read.apply(void 0,[e.sent()]),!1]))])),e.label=6;case 6:return[2,n]}})})}var w="https://api.stackexchange.com",S=(Object.defineProperty(t.prototype,"myAnswers",{get:function(){var e=this.answers,t=this.userId;return e.filter(function(e){e=e.owner;return(null==e?void 0:e.user_id)===t})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"myQuestions",{get:function(){var e=this.questions,t=this.userId;return e.filter(function(e){e=e.owner;return(null==e?void 0:e.user_id)===t})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"editedAnswers",{get:function(){var e=this.answers,t=this.userId;return e.filter(function(e){e=e.last_editor;return(null==e?void 0:e.user_id)===t})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"editedQuestions",{get:function(){var e=this.questions,t=this.userId;return e.filter(function(e){e=e.last_editor;return(null==e?void 0:e.user_id)===t})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasAnswers",{get:function(){return!!this.myAnswers.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasQuestions",{get:function(){return!!this.myQuestions.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasEditedAnswers",{get:function(){return!!this.editedAnswers.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasEditedQuestions",{get:function(){return!!this.editedQuestions.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasQuestionComments",{get:function(){return!!this.questionComments.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasAnswerComments",{get:function(){return!!this.answerComments.length},enumerable:!1,configurable:!0}),t);function t(e,t,n,r,s){this.userId=e,this.questionComments=t,this.answerComments=n,this.answers=r,this.questions=s}e.addEventListener("load",function(){return __awaiter(void 0,void 0,void 0,function(){var a,o,u,c,l,p,f,d,_;return __generator(this,function(e){switch(e.label){case 0:return(e.trys.push([0,5,,6]),a=StackExchange.options.user.userId,(o=StackExchange.question.getQuestionId())&&a)?(f=function(e){e=e.hostname;return e.slice(0,e.lastIndexOf("."))}(g),[4,y(o,__assign(__assign({},u={site:f,key:"UKKfmybQ9USA0N80jdnU8w(("}),{filter:"!--OzlnfZUU0r"}))]):[2];case 1:return c=e.sent(),[4,b(o,__assign(__assign({},u),{filter:"!4(sMnI809OE6Z2KE)"}))];case 2:return l=e.sent(),[4,m(o,__assign(__assign({},u),{filter:"!ao-)ijIL.2UJgN"}))];case 3:return p=e.sent(),d=p.map(function(e){e=e.answer_id;return v(e,__assign(__assign({},u),{filter:"!--OzlnfZUU0r"}))}),[4,Promise.all(d)];case 4:return f=e.sent(),_=function(e){var t=e.owner,e=e.reply_to_user;return[null==t?void 0:t.user_id,null==e?void 0:e.user_id].includes(a)},d=c.filter(_),_=f.flat().filter(_),_=new S(a,d,_,p,l),console.debug(_),t=_,(i=h.querySelector("#question-header + div"))&&(n="Participated",r=[[t.hasAnswers,"A"],[t.hasQuestions,"Q"],[t.hasEditedAnswers,"EA"],[t.hasEditedQuestions,"EQ"],[t.hasAnswerComments,"AC"],[t.hasQuestionComments,"QC"]].filter(function(e){return __read(e,1)[0]}).map(function(e){return __read(e,2)[1]}).join(" ")||"no",(s=h.createElement("div")).classList.add("flex--item","ws-nowrap","mb8","ml16"),s.title=n+": "+r,(t=h.createElement("span")).classList.add("fc-light","mr2"),t.textContent=n,s.append(t),t.after(" "+r+" "),i.append(s)),[3,6];case 5:return _=e.sent(),console.debug("Activity Indicator error:\n"+_),[3,6];case 6:return[2]}var t,n,r,s,i})})})}(window,document,(localStorage,location));