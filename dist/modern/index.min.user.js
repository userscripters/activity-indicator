// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Adds a user activity indicator to posts
// @grant           none
// @homepage        https://github.com/userscripters/activity-indicator#readme
// @match           https://*.stackexchange.com/questions/*
// @match           https://askubuntu.com/questions/*
// @match           https://es.stackoverflow.com/questions/*
// @match           https://ja.stackoverflow.com/questions/*
// @match           https://mathoverflow.net/questions/*
// @match           https://pt.stackoverflow.com/questions/*
// @match           https://ru.stackoverflow.com/questions/*
// @match           https://serverfault.com/questions/*
// @match           https://stackapps.com/questions/*
// @match           https://stackoverflow.com/questions/*
// @match           https://superuser.com/questions/*
// @name            Activity Indicator
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/activity-indicator.git
// @supportURL      https://github.com/userscripters/activity-indicator/issues
// @version         1.2.1
// ==/UserScript==

"use strict";((h,g,f)=>{const d="https://api.stackexchange.com",c=(e=100)=>new Promise(t=>setTimeout(t,e)),v=async(t,{site:e="stackoverflow",page:s=1,...n})=>{const i=new URL(d+`/2.3/questions/${t}/comments`);i.search=new URLSearchParams({site:e,page:s.toString(),...n}).toString();const a=await fetch(i.toString());if(!a.ok)return[];const{items:r=[],has_more:o=!1,backoff:u}=await a.json();return u?(await c(1e3*u),v(t,{site:e,page:s,...n})):(o&&r.push(...await v(t,{site:e,page:s+1,...n})),r)},p=async(t,{site:e="stackoverflow",page:s=1,...n})=>{const i=new URL(d+`/2.3/answers/${t}/comments`);i.search=new URLSearchParams({site:e,page:s.toString(),...n}).toString();const a=await fetch(i.toString());if(!a.ok)return[];const{items:r=[],has_more:o=!1,backoff:u}=await a.json();return u?(await c(1e3*u),p(t,{site:e,page:s,...n})):(o&&r.push(...await p(t,{site:e,page:s+1,...n})),r)},k=async(t,{site:e="stackoverflow",page:s=1,...n})=>{const i=new URL(d+"/2.3/questions/"+t);i.search=new URLSearchParams({site:e,page:s.toString(),...n}).toString();const a=await fetch(i.toString());if(!a.ok)return[];const{items:r=[],has_more:o=!1,backoff:u}=await a.json();return u?(await c(1e3*u),k(t,{site:e,page:s,...n})):(o&&r.push(...await k(t,{site:e,page:s+1,...n})),r)},A=async(t,{site:e="stackoverflow",page:s=1,...n})=>{const i=new URL(d+`/2.3/questions/${t}/answers`);i.search=new URLSearchParams({site:e,page:s.toString(),...n}).toString();const a=await fetch(i.toString());if(!a.ok)return[];const{items:r=[],has_more:o=!1,backoff:u}=await a.json();return u?(await c(1e3*u),A(t,{site:e,page:s,...n})):(o&&r.push(...await A(t,{site:e,page:s+1,...n})),r)},e=(t,e)=>{let s;return t.forEach(t=>((null===s||void 0===s?void 0:s[e])||0)<t[e]&&(s=t)),(null===s||void 0===s?void 0:s.link)||""};class L{constructor(t,e,s,n,i){this.userId=t,this.questionComments=e,this.answerComments=s,this.answers=n,this.questions=i}get lastEditedAnswerLink(){var t=this["editedAnswers"];return e(t,"last_activity_date")}get lastEditedQuestionLink(){var t=this["editedQuestions"];return e(t,"last_activity_date")}get lastAnswerLink(){var t=this["myAnswers"];return e(t,"creation_date")}get lastQuestionLink(){var t=this["myQuestions"];return e(t,"creation_date")}get lastAnswerComment(){var t=this["answerComments"];return e(t,"creation_date")}get lastQuestionComment(){var t=this["questionComments"];return e(t,"creation_date")}get myAnswers(){const{answers:t,userId:e}=this;return t.filter(({owner:t})=>(null==t?void 0:t.user_id)===e)}get myQuestions(){const{questions:t,userId:e}=this;return t.filter(({owner:t})=>(null==t?void 0:t.user_id)===e)}get editedAnswers(){const{answers:t,userId:e}=this;return t.filter(({last_editor:t})=>(null==t?void 0:t.user_id)===e)}get editedQuestions(){const{questions:t,userId:e}=this;return t.filter(({last_editor:t})=>(null==t?void 0:t.user_id)===e)}get hasAnswers(){var t=this["myAnswers"];return!!t.length}get hasQuestions(){var t=this["myQuestions"];return!!t.length}get hasEditedAnswers(){var t=this["editedAnswers"];return!!t.length}get hasEditedQuestions(){var t=this["editedQuestions"];return!!t.length}get hasQuestionComments(){var t=this["questionComments"];return!!t.length}get hasAnswerComments(){var t=this["answerComments"];return!!t.length}}h.addEventListener("load",async()=>{try{const u=("undefined"!=typeof unsafeWindow?unsafeWindow:h)["StackExchange"],d=u.options.user["userId"];var t=u.question.getQuestionId();if(!t||!d)return;const c={site:(o=[f["hostname"]][0],o.slice(0,o.lastIndexOf("."))),key:"UKKfmybQ9USA0N80jdnU8w(("},l=await v(t,{...c,filter:"!4(lY7*xuE9Z8LL)8k"});var e=await k(t,{...c,filter:"!LaSREm6B5Ji4nnR50YM1t4"});const m=await A(t,{...c,filter:"!)qTDdy3rflMDTMhEvVdZ"});var s=m.map(({answer_id:t})=>p(t,{...c,filter:"!4(lY7*xuE9Z8LL)8k"}));const w=await Promise.all(s);var n=({owner:t,reply_to_user:e})=>[null==t?void 0:t.user_id,null==e?void 0:e.user_id].includes(d),i=l.filter(n),a=w.flat().filter(n),r=new L(d,i,a,m,e);console.debug(L.name,r),(t=>{const e=g.querySelector("#question-header + div");if(e){var s="Participated";const n=[[t.hasAnswers,"A","Answered",t.lastAnswerLink],[t.hasQuestions,"Q","Asked",t.lastQuestionLink],[t.hasEditedAnswers,"EA","Edited an Answer",t.lastEditedAnswerLink],[t.hasEditedQuestions,"EQ","Edited the Question",t.lastEditedQuestionLink],[t.hasAnswerComments,"AC","Commented on an Answer",t.lastAnswerComment],[t.hasQuestionComments,"QC","Commented on the Question",t.lastQuestionComment]],i=n.filter(([t])=>t),a=i.map(([,t,e,s])=>{const n=g.createElement("a");return n.title=e,n.textContent=t,n.classList.add("mr4"),n.href=s||"#!",n});t=i.map(([,t])=>t).join(" ")||"no";a.length||a.push(g.createTextNode("no"));const r=g.createElement("div");r.classList.add("flex--item","ws-nowrap","mb8","ml16"),r.title=s+": "+t;const o=g.createElement("span");o.classList.add("fc-light","mr4"),o.textContent=s,r.append(o),o.after(...a),e.append(r)}})(r)}catch(t){console.debug(`Activity Indicator error:
`+t)}var o})})(window,document,(localStorage,location));