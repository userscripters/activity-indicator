// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Adds a user activity indicator to posts
// @grant           none
// @homepage        https://github.com/userscripters/activity-indicator#readme
// @match           https://*.askubuntu.com/*
// @match           https://*.mathoverflow.net/*
// @match           https://*.serverfault.com/*
// @match           https://*.stackapps.com/*
// @match           https://*.stackexchange.com/*
// @match           https://*.stackoverflow.com/*
// @name            Activity Indicator
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/activity-indicator.git
// @supportURL      https://github.com/userscripters/activity-indicator/issues
// @version         1.0.0
// ==/UserScript==

"use strict";((t,d,g)=>{const u="https://api.stackexchange.com",h=(e=100)=>new Promise(t=>setTimeout(t,e)),m=async(t,{site:e="stackoverflow",page:s=1,...n})=>{const a=new URL(`${u}/2.3/questions/${t}/comments`);a.search=new URLSearchParams({site:e,page:s.toString(),...n}).toString();const i=await fetch(a.toString());if(!i.ok)return[];const{items:r=[],has_more:o=!1,backoff:c}=await i.json();return c?(await h(1e3*c),m(t,{site:e,page:s,...n})):(o&&r.push(...await m(t,{site:e,page:s+1,...n})),r)},f=async(t,{site:e="stackoverflow",page:s=1,...n})=>{const a=new URL(`${u}/2.3/answers/${t}/comments`);a.search=new URLSearchParams({site:e,page:s.toString(),...n}).toString();const i=await fetch(a.toString());if(!i.ok)return[];const{items:r=[],has_more:o=!1,backoff:c}=await i.json();return c?(await h(1e3*c),f(t,{site:e,page:s,...n})):(o&&r.push(...await f(t,{site:e,page:s+1,...n})),r)},p=async(t,{site:e="stackoverflow",page:s=1,...n})=>{const a=new URL(`${u}/2.3/questions/${t}`);a.search=new URLSearchParams({site:e,page:s.toString(),...n}).toString();const i=await fetch(a.toString());if(!i.ok)return[];const{items:r=[],has_more:o=!1,backoff:c}=await i.json();return c?(await h(1e3*c),p(t,{site:e,page:s,...n})):(o&&r.push(...await p(t,{site:e,page:s+1,...n})),r)},v=async(t,{site:e="stackoverflow",page:s=1,...n})=>{const a=new URL(`${u}/2.3/questions/${t}/answers`);a.search=new URLSearchParams({site:e,page:s.toString(),...n}).toString();const i=await fetch(a.toString());if(!i.ok)return[];const{items:r=[],has_more:o=!1,backoff:c}=await i.json();return c?(await h(1e3*c),v(t,{site:e,page:s,...n})):(o&&r.push(...await v(t,{site:e,page:s+1,...n})),r)};class S{constructor(t,e,s,n,a){this.userId=t,this.questionComments=e,this.answerComments=s,this.answers=n,this.questions=a}get myAnswers(){const{answers:t,userId:e}=this;return t.filter(({owner:t})=>(null==t?void 0:t.user_id)===e)}get myQuestions(){const{questions:t,userId:e}=this;return t.filter(({owner:t})=>(null==t?void 0:t.user_id)===e)}get editedAnswers(){const{answers:t,userId:e}=this;return t.filter(({last_editor:t})=>(null==t?void 0:t.user_id)===e)}get editedQuestions(){const{questions:t,userId:e}=this;return t.filter(({last_editor:t})=>(null==t?void 0:t.user_id)===e)}get hasAnswers(){var t=this["myAnswers"];return!!t.length}get hasQuestions(){var t=this["myQuestions"];return!!t.length}get hasEditedAnswers(){var t=this["editedAnswers"];return!!t.length}get hasEditedQuestions(){var t=this["editedQuestions"];return!!t.length}get hasQuestionComments(){var t=this["questionComments"];return!!t.length}get hasAnswerComments(){var t=this["answerComments"];return!!t.length}}t.addEventListener("load",async()=>{try{const c=StackExchange.options.user["userId"];var t=StackExchange.question.getQuestionId();if(!t||!c)return;const u={site:(o=[g["hostname"]][0],o.slice(0,o.lastIndexOf("."))),key:"UKKfmybQ9USA0N80jdnU8w(("},h=await m(t,{...u,filter:"!--OzlnfZUU0r"});var e=await p(t,{...u,filter:"!4(sMnI809OE6Z2KE)"});const l=await v(t,{...u,filter:"!ao-)ijIL.2UJgN"});var s=l.map(({answer_id:t})=>f(t,{...u,filter:"!--OzlnfZUU0r"}));const w=await Promise.all(s);var n=({owner:t,reply_to_user:e})=>[null==t?void 0:t.user_id,null==e?void 0:e.user_id].includes(c),a=h.filter(n),i=w.flat().filter(n),r=new S(c,a,i,l,e);console.debug(r),(t=>{const e=d.querySelector("#question-header + div");if(e){var s="Participated";const n=[[t.hasAnswers,"A"],[t.hasQuestions,"Q"],[t.hasEditedAnswers,"EA"],[t.hasEditedQuestions,"EQ"],[t.hasAnswerComments,"AC"],[t.hasQuestionComments,"QC"]],a=n.filter(([t])=>t);t=a.map(([,t])=>t).join(" ")||"no";const i=d.createElement("div");i.classList.add("flex--item","ws-nowrap","mb8","ml16"),i.title=`${s}: ${t}`;const r=d.createElement("span");r.classList.add("fc-light","mr2"),r.textContent=s,i.append(r),r.after(` ${t} `),e.append(i)}})(r)}catch(t){console.debug(`Activity Indicator error:\n${t}`)}var o})})(window,document,(localStorage,location));