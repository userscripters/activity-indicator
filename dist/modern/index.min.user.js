// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Adds a user activity indicator to posts
// @grant           none
// @homepage        https://github.com/userscripters/activity-indicator#readme
// @match           https://*.askubuntu.com/*
// @match           https://*.mathoverflow.net/*
// @match           https://*.serverfault.com/*
// @match           https://*.stackapps.com/*
// @match           https://*.stackexchange.com/*
// @match           https://*.stackoverflow.com/*
// @name            Activity Indicator
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/activity-indicator.git
// @supportURL      https://github.com/userscripters/activity-indicator/issues
// @version         1.0.0
// ==/UserScript==

"use strict";((t,d,p)=>{const l="https://api.stackexchange.com",w=(e=100)=>new Promise(t=>setTimeout(t,e)),v=async(t,{site:e="stackoverflow",page:s=1,...a})=>{const n=new URL(`${l}/2.3/questions/${t}/comments`);n.search=new URLSearchParams({site:e,page:s.toString(),...a}).toString();const i=await fetch(n.toString());if(!i.ok)return[];const{items:r=[],has_more:o=!1,backoff:c}=await i.json();return c?(await w(1e3*c),v(t,{site:e,page:s,...a})):(o&&r.push(...await v(t,{site:e,page:s+1,...a})),r)},S=async(t,{site:e="stackoverflow",page:s=1,...a})=>{const n=new URL(`${l}/2.3/answers/${t}/comments`);n.search=new URLSearchParams({site:e,page:s.toString(),...a}).toString();const i=await fetch(n.toString());if(!i.ok)return[];const{items:r=[],has_more:o=!1,backoff:c}=await i.json();return c?(await w(1e3*c),S(t,{site:e,page:s,...a})):(o&&r.push(...await S(t,{site:e,page:s+1,...a})),r)},k=async(t,{site:e="stackoverflow",page:s=1,...a})=>{const n=new URL(`${l}/2.3/questions/${t}`);n.search=new URLSearchParams({site:e,page:s.toString(),...a}).toString();const i=await fetch(n.toString());if(!i.ok)return[];const{items:r=[],has_more:o=!1,backoff:c}=await i.json();return c?(await w(1e3*c),k(t,{site:e,page:s,...a})):(o&&r.push(...await k(t,{site:e,page:s+1,...a})),r)},U=async(t,{site:e="stackoverflow",page:s=1,...a})=>{const n=new URL(`${l}/2.3/questions/${t}/answers`);n.search=new URLSearchParams({site:e,page:s.toString(),...a}).toString();const i=await fetch(n.toString());if(!i.ok)return[];const{items:r=[],has_more:o=!1,backoff:c}=await i.json();return c?(await w(1e3*c),U(t,{site:e,page:s,...a})):(o&&r.push(...await U(t,{site:e,page:s+1,...a})),r)};class L{constructor(t,e,s,a){this.questionComments=t,this.answerComments=e,this.answers=s,this.questions=a}get hasAnswers(){var t=this["answers"];return!!t.length}get hasQuestions(){var t=this["questions"];return!!t.length}get hasQuestionComments(){var t=this["questionComments"];return!!t.length}get hasAnswerComments(){var t=this["answerComments"];return!!t.length}}t.addEventListener("load",async()=>{try{const w=StackExchange.options.user["userId"];var t=StackExchange.question.getQuestionId();if(!t||!w)return;const u={site:(l=[p["hostname"]][0],l.slice(0,l.lastIndexOf("."))),key:"UKKfmybQ9USA0N80jdnU8w(("},h=await v(t,{...u,filter:"!--OzlnfZUU0r"}),m=await k(t,{...u,filter:"!4(sMnI809OE6Z2KE)"}),g=await U(t,{...u,filter:"!ao-)ijIL.2UJgN"});var e=g.map(({answer_id:t})=>S(t,{...u,filter:"!--OzlnfZUU0r"}));const f=await Promise.all(e);var s=({owner:t,reply_to_user:e})=>[null==t?void 0:t.user_id,null==e?void 0:e.user_id].includes(w),a=h.filter(s),n=f.flat().filter(s),i=({last_editor:t,owner:e})=>[null==t?void 0:t.user_id,null==e?void 0:e.user_id].includes(w),r=g.filter(i),o=m.filter(i),c=new L(a,n,r,o);console.debug(c),(t=>{const e=d.querySelector("#question-header + div");if(e){var s="Participated";const a=[[t.hasAnswers,"A"],[t.hasQuestions,"Q"],[t.hasAnswerComments,"AC"],[t.hasQuestionComments,"QC"]],n=a.filter(([t])=>t);t=n.map(([,t])=>t).join(" ")||"no";const i=d.createElement("div");i.classList.add("flex--item","ws-nowrap","mb8","ml16"),i.title=`${s}: ${t}`;const r=d.createElement("span");r.classList.add("fc-light","mr2"),r.textContent=s,i.append(r),r.after(` ${t} `),e.append(i)}})(c)}catch(t){console.debug(`Activity Indicator error:\n${t}`)}var l})})(window,document,(localStorage,location));